# Base image argument
ARG BASE_IMAGE=louislam/uptime-kuma:base2

############################################
# Build Stage
############################################

# Healthcheck builder
FROM louislam/uptime-kuma:builder-go AS build_healthcheck

# Node build stage
FROM louislam/uptime-kuma:base2 AS build

WORKDIR /app

ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1

# Copy dependency files first (better Docker layer caching)
COPY package.json package.json
COPY package-lock.json package-lock.json
COPY .npmrc .npmrc

# Install dependencies as root (prevents EACCES issue)
RUN npm ci --omit=dev

# Copy remaining project files
COPY . .

# Copy healthcheck binary from Go builder
COPY --from=build_healthcheck /app/extra/healthcheck /app/extra/healthcheck

# Create required directory
RUN mkdir -p /app/data

# Fix ownership
RUN chown -R node:node /app

# Switch to non-root user
USER node


############################################
# Runtime Image
############################################

FROM $BASE_IMAGE

WORKDIR /app

LABEL org.opencontainers.image.source="https://github.com/louislam/uptime-kuma"

ENV UPTIME_KUMA_IS_CONTAINER=1

# Copy built application from build stage
COPY --chown=node:node --from=build /app /app

EXPOSE 3001

HEALTHCHECK --interval=60s \
            --timeout=30s \
            --start-period=180s \
            --retries=5 \
            CMD extra/healthcheck

ENTRYPOINT ["/usr/bin/dumb-init", "--"]

CMD ["node", "server/server.js"]
