ARG BASE_IMAGE=louislam/uptime-kuma:base2

############################################
# Build in Golang (Healthcheck)
############################################
FROM louislam/uptime-kuma:builder-go AS build_healthcheck


############################################
# Build in Node.js
############################################
FROM louislam/uptime-kuma:base2 AS build

WORKDIR /app

ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1

# Copy dependency files first (better layer caching)
COPY package.json package.json
COPY package-lock.json package-lock.json
COPY .npmrc .npmrc

# Install dependencies as root (avoids EACCES)
RUN npm ci --omit=dev

# Copy remaining project files
COPY . .

# Copy healthcheck from Go builder
COPY --from=build_healthcheck /app/extra/healthcheck /app/extra/healthcheck

# Create required directory
RUN mkdir -p /app/data

# Fix permissions before switching user
RUN chown -R node:node /app

# Switch to non-root user for security
USER node


############################################
# â­ Main Image
############################################
FROM $BASE_IMAGE AS release

WORKDIR /app

LABEL org.opencontainers.image.source="https://github.com/louislam/uptime-kuma"

ENV UPTIME_KUMA_IS_CONTAINER=1

# Copy built app from build stage
COPY --chown=node:node --from=build /app /app

EXPOSE 3001

HEALTHCHECK --interval=60s --timeout=30s --start-period=180s --retries=5 CMD extra/healthcheck

ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["node", "server/server.js"]


############################################
# Rootless Image
############################################
FROM release AS rootless
USER node


############################################
# Mark as Nightly
############################################
FROM release AS nightly
RUN npm run mark-as-nightly

FROM nightly AS nightly-rootless
USER node


############################################
# Build image for PR testing
############################################
FROM louislam/uptime-kuma:base2 AS pr-test2

WORKDIR /app

ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1

# Install Git & GitHub CLI
RUN apt update \
    && apt --yes --no-install-recommends install curl git \
    && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt update \
    && apt --yes --no-install-recommends install gh \
    && rm -rf /var/lib/apt/lists/*

# Clean directory
RUN rm -rf ./*

# Fix permissions
RUN chown -R node:node /app

USER node

RUN git config --global user.email "no-reply@no-reply.com"
RUN git config --global user.name "PR Tester"
RUN git config --global advice.detachedHead false

RUN git clone https://github.com/louislam/uptime-kuma.git .

RUN npm ci

EXPOSE 3000 3001

HEALTHCHECK --interval=60s --timeout=30s --start-period=180s --retries=5 CMD extra/healthcheck

CMD ["npm", "run", "start-pr-test"]


############################################
# Upload artifact to GitHub
############################################
FROM louislam/uptime-kuma:base2 AS upload-artifact

WORKDIR /

RUN apt update && \
    apt --yes install curl file && \
    rm -rf /var/lib/apt/lists/*

COPY --from=build /app /app

ARG VERSION
ARG GITHUB_TOKEN
ARG TARGETARCH
ARG PLATFORM=debian
ARG FILE=$PLATFORM-$TARGETARCH-$VERSION.tar.gz
ARG DIST=dist.tar.gz

RUN chmod +x /app/extra/upload-github-release-asset.sh

# Dist only
RUN cd /app && tar -zcvf $DIST dist

RUN /app/extra/upload-github-release-asset.sh \
    github_api_token=$GITHUB_TOKEN \
    owner=louislam \
    repo=uptime-kuma \
    tag=$VERSION \
    filename=/app/$DIST
